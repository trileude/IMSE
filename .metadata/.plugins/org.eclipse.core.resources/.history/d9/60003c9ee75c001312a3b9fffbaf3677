package transformation

import org.eclipse.emf.common.util.URI
import org.eclipse.emf.ecore.resource.ResourceSet
import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl

import fr.esir.imse.PollSystemStandaloneSetup
import fr.esir.imse.pollSystem.PollSystem
import fr.esir.imse.pollSystem.Poll

import org.xtext.example.mydsl.MyDslStandaloneSetup
import org.xtext.example.mydsl.myDsl.ListeQuestions
import org.xtext.example.mydsl.myDsl.Question

import java.util.Iterator
import mmui.MmuiFactory
import mmui.ElementUI

class Transformation {
	
	def PollSystem parsingPollSystem(String nomFichier) {
		
		// Create a resource set.
  		var ResourceSet resourceSet = new ResourceSetImpl();
  		
  		PollSystemStandaloneSetup.doSetup
  		var resource = resourceSet.getResource(URI.createURI(nomFichier), true)
  		var ps = resource.contents.head as PollSystem
  		//println(ps.polls.size)
  		return(ps)
	}
	
	def ListeQuestions parsingMapping(String nomFichier) {
		
		// Create a resource set.
  		var ResourceSet resourceSet = new ResourceSetImpl();
  		
  		MyDslStandaloneSetup.doSetup
  		var resource = resourceSet.getResource(URI.createURI(nomFichier), true)
  		var listeQuestions = resource.contents.head as ListeQuestions
  		//println(listeQuestions.toString());
  		return(listeQuestions)
	}
	
	def void tranform(String pollSystemFile, String mappingFile){
		
		//parsing
		var ps = parsingPollSystem(pollSystemFile) as PollSystem
		var map = parsingMapping(mappingFile) as ListeQuestions
		
		var itPs = ps.polls.iterator as Iterator<Poll>
		var itMap = map.questions.iterator as Iterator<Question> 
		
		// Create model mmui
		var ui = MmuiFactory.eINSTANCE.createLayout
				
		//firstPoll
		if(itPs.hasNext())
		{
			var itQuestionsPaul = itPs.next().questions.iterator as Iterator<fr.esir.imse.pollSystem.Question>
			if(itQuestionsPaul.hasNext())
			{
				var pollQuestion = itQuestionsPaul.next()
				var courant = MmuiFactory.eINSTANCE.createCheckBox as ElementUI
				courant.id = pollQuestion.id
				courant.question = 	pollQuestion.text
				ui.firstElement = courant
				while(itQuestionsPaul.hasNext())
				{
					pollQuestion = itQuestionsPaul.next()
					courant.next = MmuiFactory.eINSTANCE.createCheckBox
					courant.next.id = pollQuestion.id
					courant.next.question = pollQuestion.text
					courant = courant.next
				}
			}
		}
	}
	
}